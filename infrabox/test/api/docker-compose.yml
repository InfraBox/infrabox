version: "3.2"

services:
    postgres:
        build:
            context: ../../../
            dockerfile: ./src/postgres/Dockerfile

    minio:
        image: minio/minio
        command: server /data
        environment:
            - MINIO_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
            - MINIO_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

    test:
        build:
            context: ../../../
            dockerfile: ./infrabox/test/api/Dockerfile
        environment:
            - INFRABOX_DATABASE_HOST=postgres
            - INFRABOX_DATABASE_USER=postgres
            - INFRABOX_DATABASE_PASSWORD=postgres
            - INFRABOX_DATABASE_DB=postgres
            - INFRABOX_DATABASE_PORT=5432
            - INFRABOX_STORAGE_GCS_ENABLED=false
            - INFRABOX_STORAGE_S3_ENABLED=true
            - INFRABOX_STORAGE_S3_PROJECT_UPLOAD_BUCKET=project-upload
            - INFRABOX_STORAGE_S3_CONTAINER_OUTPUT_BUCKET=container-output
            - INFRABOX_STORAGE_S3_CONTAINER_CONTENT_CACHE_BUCKET=content-cache
            - INFRABOX_STORAGE_S3_SECURE=false
            - INFRABOX_STORAGE_S3_ACCESS_KEY=AKIAIOSFODNN7EXAMPLE
            - INFRABOX_STORAGE_S3_SECRET_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
            - INFRABOX_STORAGE_S3_ENDPOINT=minio
            - INFRABOX_STORAGE_S3_PORT=9000
            - INFRABOX_JOB_SECURITY_CONTEXT_CAPABILITIES_ENABLED=false
            - INFRABOX_DOCKER_REGISTRY_URL=.
            - GOOGLE_APPLICATION_CREDENTIALS=
            - INFRABOX_ROOT_URL=localhost
            - CODECOV_TOKEN=$CODECOV_TOKEN
            # Account
            - INFRABOX_ACCOUNT_SIGNUP_ENABLED=true
            - INFRABOX_ACCOUNT_LDAP_ENABLED=false
            # Github
            - INFRABOX_GITHUB_ENABLED=true
            - INFRABOX_GITHUB_LOGIN_ENABLED=true
            - INFRABOX_GITHUB_LOGIN_URL=https://github.com/login
            - INFRABOX_GITHUB_API_URL=https://api.github.com
            - INFRABOX_GITHUB_CLIENT_ID=andrewahapov
            # Gitlab
            - INFRABOX_GITLAB_ENABLED=true
            - INFRABOX_GITLAB_LOGIN_ENABLED=true
            - INFRABOX_GITLAB_API_URL=http://localhost:1357/api/v3
            - INFRABOX_GITLAB_LOGIN_URL=http://localhost:1357/users/sign_in
            - INFRABOX_GITLAB_OAUTH_URL=http://localhost:1357/oauth/authorize
            - INFRABOX_GITLAB_APPLICATION_ID=5dbbd5871a4c1fee17783c24bde94bc5b2ca86b5c3b76e485f131e765a0d715e
            - INFRABOX_GITLAB_APPLICATION_SECRET=f45c7cf0a894f220d1d5893785c9080a9c123fdab23aebbc34c87aac1a9273cd
        links:
            - postgres
            - minio
